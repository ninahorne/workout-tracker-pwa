#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook to sync environment variables when pushing to main

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç Checking push target...${NC}"

# Get the branch being pushed to
remote="$1"
url="$2"

# Read the push details from stdin
while read local_ref local_sha remote_ref remote_sha; do
    # Extract branch name from remote_ref (refs/heads/main -> main)
    branch_name=$(echo "$remote_ref" | sed 's|refs/heads/||')
    
    echo -e "${BLUE}üì§ Pushing to branch: ${YELLOW}$branch_name${NC}"
    
    # Check if pushing to main branch
    if [ "$branch_name" = "main" ] || [ "$branch_name" = "master" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Pushing to $branch_name branch detected!${NC}"
        
        # Check if .env.production exists
        if [ -f ".env.production" ]; then
            echo -e "${GREEN}üìÅ Found .env.production file${NC}"
            
            # Check if user is logged in to Vercel
            if npx vercel whoami >/dev/null 2>&1; then
                echo -e "${GREEN}‚úÖ Vercel CLI authenticated${NC}"
                echo -e "${BLUE}üîÑ Syncing environment variables to Vercel...${NC}"
                
                # Run the safe sync script
                if node scripts/sync-env-safe.js; then
                    echo -e "${GREEN}‚úÖ Environment variables synced successfully!${NC}"
                else
                    echo -e "${RED}‚ùå Failed to sync environment variables${NC}"
                    echo -e "${YELLOW}‚ö†Ô∏è  Push continuing anyway, but you may need to sync manually${NC}"
                fi
            else
                echo -e "${YELLOW}‚ö†Ô∏è  Not logged in to Vercel CLI${NC}"
                echo -e "${YELLOW}üí° Run 'npx vercel login' to enable automatic env sync${NC}"
                echo -e "${YELLOW}üìù Or manually sync with 'npm run sync-env' after login${NC}"
            fi
        else
            echo -e "${YELLOW}‚ö†Ô∏è  No .env.production file found${NC}"
            echo -e "${YELLOW}üí° Create .env.production to enable automatic env sync${NC}"
        fi
        
        echo -e "${GREEN}üöÄ Proceeding with push to $branch_name...${NC}"
    else
        echo -e "${BLUE}‚ÑπÔ∏è  Not pushing to main/master, skipping env sync${NC}"
    fi
done

echo -e "${GREEN}‚ú® Pre-push checks completed${NC}"
